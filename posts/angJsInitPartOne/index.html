<!doctype html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="Download of a third-party JavaScript library and a way to “hook” to the initialization of the Angular application. Example with Analytics.js. Part One.">
    <meta name="referrer" content="origin">
    <meta name="content-security-policy" content="default-src 'none';script-src 'self' 'unsafe-inline';style-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com;img-src 'self';media-src 'none';frame-src 'self';font-src 'self' data: https://fonts.gstatic.com;connect-src https://cdnjs.cloudflare.com 'self';child-src 'self';form-action 'self';frame-ancestors 'self';manifest-src 'none';worker-src 'none'">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='preconnect stylesheet'>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="preconnect stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/brands.min.css"  rel="preconnect stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/railscasts.min.css" rel="preconnect stylesheet">
    <title>Angular. Download of a third-party JavaScript library. Part One.</title>
    <link rel="stylesheet" href="/css/site.css">
</head>

<body class="dark_body">

    <!--Top Navbar-->
<div class="navbar-fixed">
    <nav>
        <div class="nav-wrapper">
            <a href="/" class="brand-logo">
                <span class="logo_name">Александър Гьонов</span>
            </a>
            <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                
                
                <li><a href="/bg/blog/" >БЛОГ</a>
                </li>
                
                
                <li><a href="/bg/about/" >ЗА МЕН</a>
                </li>
                
            </ul>
        </div>
    </nav>
</div>

<!--Side nave for mobile-->
<ul class="sidenav" id="mobile-demo">
    <li>
        <div class="user-view">
            <div class="background" id="sidenav_header">
                <img src="/img/side_background.webp" alt="me_background">
            </div>
            <a href="/"><img src="/img/art_normal_small.webp" alt="Александър Гьонов"
                    class="circle responsive-img"></a>
            <a href="/"><span class="white-text name">Здрасти, аз съм Сашо</span></a>
        </div>
    </li>
    
    
    <li>
        <a href="/bg/blog/" ><i
                class="material-icons">rss_feed</i>БЛОГ</a>
    </li>
    
    
    <li>
        <a href="/bg/about/" ><i
                class="material-icons">person</i>ЗА МЕН</a>
    </li>
    
    <li>
        <div class="divider"></div>
    </li>
    <li><a class="subheader">Контакти</a></li>
    <li>
        <a href="https://hachyderm.io/@agionov" target="_blank" rel="me noreferrer external noopener" title="Mastodon">
            <i class="fa fa-brands fa-mastodon" style="font-size: 20px"></i>Mastodon</a>
    </li>
    <li>
        <a href="https://twitter.com/agionov" target="_blank" rel="noreferrer external noopener" title="Twitter">
            <i class="fa fa-brands fa-twitter" style="font-size: 20px"></i>Twitter</a>
    </li>
    <li>
        <a href="https://www.linkedin.com/in/agionov" target="_blank" rel="noreferrer external noopener"
            title="LinkedIn">
            <i class="fa fa-brands fa-linkedin" style="font-size: 20px"></i>LinkedIn</a>
    </li>
    <li>
        <a href="https://github.com/agyonov" target="_blank" rel="noreferrer external noopener" title="GitHub">
            <i class="fa fa-brands fa-github" style="font-size: 20px"></i>GitHub</a>
    </li>
    <li>
        <div class="divider"></div>
    </li>
    <li><a class="subheader">Език</a></li>
    <li>
        
        <a href="/posts/angJsInitPartOne/"><i class="material-icons">language</i>Български</a>
        
    </li>
    <li>
        <a href="/posts/angJsInitPartOne/"><i class="material-icons">language</i>English</a>
    </li>
    <li>
        <div class="divider"></div>
    </li>
    <li><a class="subheader">Тема</a></li>
    <li>
        <a href="/posts/angJsInitPartOne/" id="toggleLigthM">
            <i class="material-icons">light_mode</i>Светъл режим</a>
        <a href="/posts/angJsInitPartOne/" class="hide" id="toggleDarkM">
            <i class="material-icons">dark_mode</i>Тъмен режим</a>
    </li>
</ul>

<!-- Page Layout here -->
<div class="row">
    <div class="col l3 xl2 hide-on-med-and-down"> <!-- Note that "m4 l3" was added -->
        <div class="flex-container" id="divLeftPane">
            <div class="flex-item">
                <div class="space_above">&nbsp;</div>
                <img src="/img/art_normal_small.webp" alt="Александър Гьонов" class="circle responsive-img">
                <h5>Здрасти, аз съм Сашо</h5>
            </div>
            <div class="flex-item">
                <h6>Контакти</h6>
                <div class="contacts">
                    <a href="https://hachyderm.io/@agionov" target="_blank" rel="me noreferrer external noopener"
                        class="slink tooltipped" data-position="bottom" data-tooltip="Mastodon">
                        <i class="fa fa-brands fa-mastodon" style="font-size: 20px"></i></a>
                    <a href="https://twitter.com/agionov" target="_blank" rel="noreferrer external noopener"
                        class="slink tooltipped" data-position="bottom" data-tooltip="Twitter">
                        <i class="fa fa-brands fa-twitter" style="font-size: 20px"></i></a>
                    <a href="https://www.linkedin.com/in/agionov" target="_blank" rel="noreferrer external noopener"
                        class="slink tooltipped" data-position="bottom" data-tooltip="LinkedIn">
                        <i class="fa fa-brands fa-linkedin" style="font-size: 20px"></i></a>
                    <a href="https://github.com/agyonov" target="_blank" rel="noreferrer external noopener"
                        class="slink tooltipped" data-position="bottom" data-tooltip="GitHub">
                        <i class="fa fa-brands fa-github" style="font-size: 20px"></i></a>
                </div>
            </div>
            <div class="flex-item-grow">&nbsp;</div>
            <div class="flex-item">
                [
                
                <span class="langLink"><a href="/posts/angJsInitPartOne/" class="slink tooltipped"
                        data-position="top" data-tooltip="Български">БГ</a></span>
                
                <span class="langLink"><a href="/posts/angJsInitPartOne/" class="slink tooltipped"
                        data-position="top" data-tooltip="English">EN</a></span>
                ]
            </div>
            <div class="flex-item wide">
                <hr class="wide">
                <a class="waves-effect waves-teal btn-flat light_button tooltipped" id="toggleLigth"
                    data-position="right" data-tooltip="Светъл режим">
                    <i class="material-icons">light_mode</i>
                </a>
                <a class="waves-effect waves-teal btn-flat hide tooltipped" id="toggleDark" data-position="right"
                    data-tooltip="Тъмен режим">
                    <i class="material-icons">dark_mode</i>
                </a>
            </div>
        </div>
    </div>
    <div class="col s12 m12 l9 xl10">
        <div class="container">
            
<div class="post_content">
    <h1>Download of a third-party JavaScript library and a way to “hook” to the initialization of the Angular application. Example with Analytics.js. Part One.</h1>
<h4>Feb 7, 2019</h4>
<p><img src="/img/angJsInitPartOne.webp" alt="Download of a third-party JavaScript library and a way to “hook” to the initialization of the Angular application. Example with Analytics.js. Part One."></p>
<p>For a while, in my professional work, I have been developing software applications using Angular. In a few cases I have faced questions about how one or other thing could have happened and I have not found a quick and unambiguous answer for myself. In this post I will discuss two interesting things of this nature:</p>
<ol>
<li>How dynamically, from Angular, to “download” in the app third-party JavaScript libraries</li>
<li>How to “hook” to the initialization process of an Angular application and run our own script</li>
</ol>
<p>For illustration I have written a sample application that I will quote in several places in the post.</p>
<p>The code for the example application is available at: <a href="https://github.com/agyonov/NgInitGA">https://github.com/agyonov/NgInitGA</a></p>
<p>The app itself is live on: <a href="https://agyonov.github.io/NgInitGA">https://agyonov.github.io/NgInitGA</a></p>
<h2>Dynamic download of a third-party JavaScript library</h2>
<p>For most libraries that you would like to use, someone has already created, developed and maintains an NPM package with the relevant Angular modules and you could (and should) use them. But sometimes there is no ready NPM package or you do not like one that is available. Then you can directly reference the requested JavaScript library from your <em>Angular</em> application and use it.</p>
<p>There are two easy approaches that are described in the <em>Angular</em> documentation and, for example, in <em>Google Analytics</em>. And which don’t always do the work for one reason or another.</p>
<p><strong>The first</strong>, entirely <em>Angular</em>, solution is to download the corresponding .js file from the Internet. Add it to your project and place a reference to the .js library in the scripts array, in the angular.json config file. E.g:</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
...
<span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-string">&quot;src/scripts/analytics.js&quot;</span>
           <span class="hljs-punctuation">]</span>
...
<span class="hljs-punctuation">}</span>
</code></pre>
<p>As described in detail in the documentation of Angular, at <a href="https://angular.io/guide/workspace-config#additional-build-and-test-options">Additional build and test options</a>.</p>
<p>It’s OK as an approach and will work.</p>
<p><strong>A consideration</strong> against its possible use is that under this approach is that the .js script will be download from your hosting server and not from the original server (in this case <a href="https://www.google-analytics.com/analytics.js">https://www.google-analytics.com/analytics.js</a>). And the question is not so much in increased traffic to your site and performance issues, but in that the author of the library (Google) could change things in it, have new versions, etc., and you will not have this new version until you re-build and do not re-publish your app.</p>
<p><strong>The second</strong> approach is to apply the instruction on the Google Analytics page <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/#alternative_async_tracking_snippet">Alternative async tracking snippet</a>:</p>
<pre><code class="language-js">&lt;script&gt;
<span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span>=<span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span>||<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>){(ga.<span class="hljs-property">q</span>=ga.<span class="hljs-property">q</span>||[]).<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">arguments</span>)};
ga.<span class="hljs-property">l</span>=+<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>;
<span class="hljs-title function_">ga</span>(<span class="hljs-string">&#x27;create&#x27;</span>, <span class="hljs-string">&#x27;UA-XXXXX-Y&#x27;</span>, <span class="hljs-string">&#x27;auto&#x27;</span>);
<span class="hljs-title function_">ga</span>(<span class="hljs-string">&#x27;send&#x27;</span>, <span class="hljs-string">&#x27;pageview&#x27;</span>);
&lt;/script&gt;
<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#x27;https://www.google-analytics.com/analytics.js&#x27;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>And the above code to be pasted directly into the <em>index.html</em> file initializing your <em>Angular</em> application. <strong>In particular, the last line of the above sample code.</strong></p>
<p>It’s OK as an approach and will also work in <strong>its part to download the .js library</strong>. In addition, here the objections which were valid for the first decision are irrelevant.</p>
<p><strong>A consideration</strong> against its possible use is stylistic – not a “clean” <em>Angular</em> solution.</p>
<p>The rest of the code snip from <em>Google Analytics</em>, shown above, <strong>does not work for us at all</strong>! Because with <em>Angular</em> we have a <strong>Single page Application</strong> (SPA) where, unlike traditional web applications, in reality only the first page is loaded from the Web server and subsequently every transition from page to page, occurs only inside the SPA application in the browser. Also, if we have any special events (e.g. button press) they as well occur inside the <em>Angular</em> app and will not affect the data in <em>Google Analytics</em>.</p>
<img src="/img/angJsInitPartOne-image-2.webp" width="800" height="600" style="display: block; margin: 0 auto" alt="angular SPA interaction">
<p>These issues are discussed in detail in the <em>Google Analytics</em> documentation itself under the <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/single-page-applications">Single Page Application Tracking</a> topic.</p>
<p>Let’s get back to the issue with the dynamic download of the JavaScript library. There is a <strong>third method</strong> that I will look at. Because the example is using Google Analytics, I’ll expand it to be used to track users’ actions in the Angular app.</p>
<p><strong>Note</strong>: As for tracking of users in Angular application, it has great, ready-made libraries, such as <em>angulartics</em>, which you can use. Here the question is not to create another such library, but to illustrate with an example a possible solution to the two questions set at the beginning of this post!</p>
<p>So, the dynamic download. Let us see a sample of the following Angular service:</p>
<pre><code class="language-TypeScript"><span class="hljs-comment">// Typescript extention of Window interface</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> { <span class="hljs-attr">ga</span>: <span class="hljs-built_in">any</span>; }
}

<span class="hljs-meta">@Injectable</span>({
  <span class="hljs-attr">providedIn</span>: <span class="hljs-string">&#x27;root&#x27;</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoogleAnalyticsService</span> {

  <span class="hljs-comment">// The source for the load</span>
  <span class="hljs-keyword">private</span> googleAnalyticsScript= {
    <span class="hljs-attr">loaded</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;https://www.google-analytics.com/analytics.js&#x27;</span>
  };

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-meta">@Inject</span>(PLATFORM_ID) <span class="hljs-keyword">private</span> platformId: <span class="hljs-built_in">Object</span>,
    <span class="hljs-meta">@Inject</span>(DOCUMENT) <span class="hljs-keyword">private</span> dom: Document</span>) {
  }

  <span class="hljs-comment">// Init the GA infrastructure</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">loadScript</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// Check already loaded</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">googleAnalyticsScript</span>.<span class="hljs-property">loaded</span>) {
      <span class="hljs-comment">// Check if we are at browser</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isPlatformBrowser</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">platformId</span>)) {
        <span class="hljs-comment">// Create new scipt element</span>
        <span class="hljs-keyword">const</span> <span class="hljs-attr">scriptElm</span>: <span class="hljs-title class_">HTMLScriptElement</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dom</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;script&#x27;</span>);
        scriptElm.<span class="hljs-property">src</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">googleAnalyticsScript</span>.<span class="hljs-property">url</span>;
        scriptElm.<span class="hljs-property">type</span> = <span class="hljs-string">&#x27;text/javascript&#x27;</span>;
        scriptElm.<span class="hljs-property">async</span> = <span class="hljs-literal">true</span>;
        scriptElm.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// Prevent from load second time</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">googleAnalyticsScript</span>.<span class="hljs-property">loaded</span> = <span class="hljs-literal">true</span>;
        };

        <span class="hljs-comment">// Define GA object</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span> || <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) { (<span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span>.<span class="hljs-property">q</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span>.<span class="hljs-property">q</span> || []).<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">arguments</span>); };
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span>.<span class="hljs-property">l</span> = +<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>;

        <span class="hljs-comment">// Set some Google Analytics stuff</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">ga</span>(<span class="hljs-string">&#x27;create&#x27;</span>, environment.<span class="hljs-property">propertyID</span>, <span class="hljs-string">&#x27;auto&#x27;</span>);

        <span class="hljs-comment">// Add to document</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dom</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(scriptElm);
      }
    }
  }
}
</code></pre>
<p>Basically, it’s a transcription in TypeScript, of the instructions from the Google Analytics page, which we have above. The important points are:</p>
<ul>
<li>🔻 Only in the beginning we expand the TypeScript Window interface with a new field-‘ga’</li>
<li>🔻 In the ‘loadScript’ method, the actual work is done:</li>
<li>🔻A scriptElm script element is created and is dynamically added to the DOM of the Web page. It’s the same as putting:<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#x27;https://www.google-analytics.com/analytics.js&#x27;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
in index.html.</li>
<li>🔻Definition of the ‘ga’ field with which the Window interface is expanded, as specified by Google Analytics. It’s the same as putting:<pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
<span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span>=<span class="hljs-variable language_">window</span>.<span class="hljs-property">ga</span>||<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>){(ga.<span class="hljs-property">q</span>=ga.<span class="hljs-property">q</span>||[]).<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">arguments</span>)};
ga.<span class="hljs-property">l</span>=+<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>;
<span class="hljs-title function_">ga</span>(<span class="hljs-string">&#x27;create&#x27;</span>, <span class="hljs-string">&#x27;UA-XXXXX-Y&#x27;</span>, <span class="hljs-string">&#x27;auto&#x27;</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
in index.html.</li>
</ul>
<p>And voila!</p>
<p>😊 well not quite… Still, the ‘loadScript‘ method should be invoked, somewhere from the Angular application and cause the browser to start the download of the JavaScript library. And here we come to the second question:</p>
<h2>How to “Hook” to the initializing of an Angular application</h2>
<p>But this post is already a bit long. I guess it’s time to finish this first part. For “hooking” to the initialization of the Angular application, check  part two.</p>

</div>
        </div>
    </div>
</div>

    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript" src="/js/materialize.min.js"></script>
    <script type="text/javascript" src="/js/light_dark.js"></script>
    <script type="text/javascript" src="/js/layout.js"></script>
</body>

</html>